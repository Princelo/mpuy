{% extends 'base.html.twig' %}

{% block body %}
    <div class="home-header">
        <div class="home-header-bg">
            <div class="username">{{ nickname }}</div>
        </div>
        <div class="tips-block">
            <div class="tips">{% if isOwn == true %}我的{% else %}{{ p.name }} {% endif %}商品详情</div>
        </div>
        <div class="avatar">
            <img src="{{ avatar }}" />
        </div>
    </div>
    <div class="goods-list">
        <div class="goods-item">
            <div class="avatar">
                <img src="{{ p.user.avatar }}" />
            </div>
            <div class="goods-details" style="">
                <div class="title"><i class="level"></i><a href="javascript:void(0);">{{ p.user.nickname }}</a></div>
                <div class="details">
                    {{ p.intro|nl2br }}
                </div>
                <div class="img-list">
                    <div class="my-gallery" itemscope itemtype="">
                        {% for img in images %}
                        <figure itemprop="associatedMedia" itemscope itemtype="">
                            <a href="#" itemprop="contentUrl" data-size="600x400" onclick="return photoswipe_action(0)">
                                <img src="/attachments/wechat_img/{{ img.id }}" itemprop="thumbnail" alt="" />
                            </a>
                            <!--<figcaption itemprop="caption description">Image caption</figcaption>-->
                        </figure>
                        {% endfor %}

                    </div>
                    <div style="clear:both"></div>
                </div>
                <div class="attr">
                    <div class="attr_left">
                        {% if p.isReturnable == true %}<i class="icon-text blue">包退</i>{% endif %}
                        {% if p.isFreePostage == true %}<i class="icon-text orange">包邮</i>{% endif %}
                        <i class="icon ensure"></i>
                        <label class="date">{{ p.createTime|date('m月d日') }}</label>
                    </div>
                    <div class="attr_right">
                        <span id="likes_count{{ p.id }}">{{ p.likeCount|number_format }}</span><i class="icon like" onclick="like_send({{ p.id }})"></i>
                    </div>
                </div>
                <div style="clear:both;"></div>
                <div class="likes" id="likes{{ p.id }}">
                    <div class="title">TA们赞了此拍品:</div>
                    {% for u in p.likeUsers %}
                        <a href="{{ path('profile_third', {'user_id': u.id}) }}">
                            <img src="{{ u.avatar }}" />
                        </a>
                    {% endfor %}
                    <div style="clear:both;"></div>
                </div>
                <div style="clear:both; height:10px;"></div>
                <div class="countdown-block">
                    {% if is_expired != true %}
                    <div class="running-tip">距离结束:</div>
                    <div class="countdown-tip"><label class="countdown" id="countdown"></label></div>
                    {% endif %}
                </div>
                <div class="action-block">
                    {% if isOwn == false %}<a class="update" href="javascript:void(0);" onclick="update_bid_list({{ p.id }})">更新</a>{% endif %}
                    {% if isOwn == true %}<a class="bid-btn" onclick="update_bid_list({{ p.id }})">更新</a>{% endif %}
                    {% if isOwn == false %}<a class="bid-btn" onclick="bid()">出价</a>{% endif %}
                    <div class="action-info">
                        <div class="start-price"><span>起</span><label>￥{{ p.startPrice|number_format }}元</label></div>
                        <span class="splitter">|</span>
                        <div class="step-price"><span>加</span><label>￥{{ p.stepPrice|number_format }}元</label></div>
                    </div>
                </div>
                <div class="bid-list" id="bid-list{{ p.id }}">
                    <!--<ul>
                        <li>
                            <img class="avatar" src="epuy_images/avatar1.png" />
                            <div class="bid-info">
                                <a href="javascript:void(0);">云</a>
                                <label>￥228元</label>
                            </div>
                            <div class="bid-order-info">
                                <div class="order-info leading">领先</div>
                                <div style="clear:both;"></div>
                                <div class="datetime">09-03 14:57</div>
                            </div>
                        </li>
                        <li>
                            <img class="avatar" src="epuy_images/avatar2.png" />
                            <div class="bid-info">
                                <a href="javascript:void(0);">ˇ坚果墙♛</a>
                                <label>￥198元</label>
                            </div>
                            <div class="bid-order-info">
                                <div class="order-info dumped-out">出局</div>
                                <div style="clear:both;"></div>
                                <div class="datetime">09-03 12:46</div>
                            </div>
                        </li>
                    </ul>-->
                </div>
            </div>
            <div id="bid-box{{ p.id }}" class="bid-box" style="display:none;">
                <div class="box-inner">
                    <a class="bid-btn" onclick="bid_send({{ p.id }})" id="bid_send{{ p.id }}">出价</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

        <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
        <div class="pswp__bg"></div>

        <!-- Slides wrapper with overflow:hidden. -->
        <div class="pswp__scroll-wrap">

            <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>

            <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
            <div class="pswp__ui pswp__ui--hidden">

                <div class="pswp__top-bar">

                    <!--  Controls are self-explanatory. Order can be changed. -->

                    <div class="pswp__counter"></div>

                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                    <button class="pswp__button pswp__button--share" title="Share"></button>

                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                    <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                    <!-- element will get class pswp__preloader--active when preloader is running -->
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div>

                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>

                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>

                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>

            </div>

        </div>

    </div>
{% endblock %}
{% block stylesheets %}
    {% stylesheets '@AppBundle/Resources/public/css/home/*' filter='cssrewrite' %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
    <link rel="stylesheet" href="{{ asset('bundles/app/PhotoSwipe/default-skin/default-skin.css') }}" />
    <link rel="stylesheet" href="{{ asset('bundles/app/PhotoSwipe/photoswipe.css') }}" />
{% endblock %}
{% block javascripts %}
    {# javascripts '@AppBundle/Resources/public/PhotoSwipe/*.js' %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts #}
    <script src="{{ asset('bundles/app/CountDown/countdown.js') }}"></script>
    <script>
        var like_send = function (pid) {
            $.ajax({
                type: 'post',
                data: {
                    'product_id': pid
                },
                url: '{{ path('ajax_like_send') }}',
                success: function(response) {
                    if (response.state == 'success') {
                        $('#likes_count'+pid).html(parseInt($('#likes_count'+pid).html())+1);
                        $('#likes'+pid).html($('#likes'+pid).html()+"<a href='{{ path('profile') }}'><img src='{{ avatar }}' /></a>");
                    }
                }
            });
        }
        var photoswipe_action = function (i) {
            var images = [{% for img in images %}
                    'http://ct-life.cn/attachments/wechat_img/{{ img.id }}',
                {% endfor %}];
            wx.previewImage({
                current: images[i], // 当前显示图片的http链接
                urls: images // 需要预览的图片http链接列表
            });
        }
        var photoswipe_action_bak = function(i) {
            var pswpElement = document.querySelectorAll('.pswp')[0];

            // build items array
            var items = [
                {
                    src: 'epuy_images/1.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/2.jpg',
                    w: 900,
                    h: 1200
                },
                {
                    src: 'epuy_images/3.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/4.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/5.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/6.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/7.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/8.jpg',
                    w: 600,
                    h: 400
                },
                {
                    src: 'epuy_images/9.jpg',
                    w: 600,
                    h: 400
                },
            ];

            // define options (if needed)
            var options = {
                // optionName: 'option value'
                // for example:
                shareEl: false,
                zoomEl: true,
                index: i // start at first slide
            };

            // Initializes and opens PhotoSwipe
            var gallery = new PhotoSwipe( pswpElement, PhotoSwipeUI_Default, items, options);
            gallery.init();
            return false;
        }
        {% if is_expired != true %}
        var clock1 = document.getElementById('countdown')
                , targetDate = {{ p.expireTime|date('U') }}*1000;

        clock1.innerHTML = countdown(targetDate).toString();
        setInterval(function(){
            clock1.innerHTML = countdown(targetDate).toString();
        }, 1000);
        {% endif %}
        var bid = function (product_id) {
            $('#bid-box'+product_id).animate({bottom:"0px"}, "fast");
        }
        var bid_none = function () {
            $('.bid-box').animate({bottom:"-200px"}, "fast");
        }
        var bid_send = function (product_id) {
            var result = prompt("请输入金额");
            function isInt(n){
                n = parseInt(n);
                return Number(n) === n && n % 1 === 0;
            }
            if ( !isInt(result)) {
                alert('无效金额');
            } else {
                $.ajax({
                    url: "{{ path('ajax_bid_send') }}",
                    type: "post",
                    data: {
                        'product_id' : product_id,
                        'volume' : result
                    },
                    success: function (response) {
                        if (response.state == 'success') {
                            alert('出价成功');
                            update_bid_list(product_id);
                        } else {
                            alert(response.message);
                            if(response.type == 'ended') {
                                $('#bid_send'+product_id).html('已结束');
                                $('#bid_send'+product_id).prop('disabled', 'disabled');
                            }
                        }
                    }
                })
            }
        }

        var update_bid_list = function (product_id) {
            $.ajax({
                type: 'post',
                url: '{{ path('ajax_get_bid_list') }}',
                data: {
                    'product_id' : product_id
                },
                success: function (bid_list) {
                    var template = '<ul>';
                    var n = 0;
                    if (bid_list == 'ended') {
                        template = "";
                        $('#bid_send'+product_id).html('已结束');
                        //$('#bid_send'+product_id).prop('disabled', 'disabled');
                    } else {
                        for( var i = 0; i < bid_list.length; i ++ ) {
                            if (i == 0) {
                                template += '<li>'+
                                        '<img class="avatar" src="'+ bid_list[i].avatar+'" />'+
                                        '<div class="bid-info">'+
                                        '<a href="javascript:void(0);">'+ bid_list[i].nickname +'</a>'+
                                        '<label>￥'+ bid_list[i].volume +'元</label>'+
                                        '</div>'+
                                        '<div class="bid-order-info">'+
                                        '<div class="order-info leading">领先</div>'+
                                        '<div style="clear:both;"></div>'+
                                        '<div class="datetime">' + bid_list[i].datetime.date.substring(5, 15) + '</div>'+
                                        '</div>'+
                                        '</li>';
                                /*} else if ((n == 1 && b.type=='ended')) {
                                 template += '<li>'+
                                 '<img class="avatar" src="'+ b.avatar+'" />'+
                                 '<div class="bid-info">'+
                                 '<a href="javascript:void(0);">'+ b.nickname +'</a>'+
                                 '<label>￥'+ b.volume +'元</label>'+
                                 '</div>'+
                                 '<div class="bid-order-info">'+
                                 '<div class="order-info leading">成交</div>'+
                                 '<div style="clear:both;"></div>'+
                                 '<div class="datetime">' + b.datetime + '</div>'+
                                 '</div>'+
                                 '</li>';*/
                            } else {
                                template += '<li>'+
                                        '<img class="avatar" src="'+ bid_list[i].avatar+'" />'+
                                        '<div class="bid-info">'+
                                        '<a href="javascript:void(0);">'+ bid_list[i].nickname +'</a>'+
                                        '<label>￥'+ bid_list[i].volume +'元</label>'+
                                        '</div>'+
                                        '<div class="bid-order-info">'+
                                        '<div class="order-info dumped-out">出局</div>'+
                                        '<div style="clear:both;"></div>'+
                                        '<div class="datetime">' + bid_list[i].datetime.date.substring(5, 15) + '</div>'+
                                        '</div>'+
                                        '</li>';
                            }
                        }
                        template += '</ul>';
                    }
                    $('#bid_list'+product_id).html(template);
                }
            })
        }
    </script>
    {% include 'menu.html.twig' %}
{% endblock %}
